<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKART | Best Online Shopping</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* লোগো স্টাইল */
        .brand-logo img {
            height: 40px;
            width: auto;
            border-radius: 4px;
            vertical-align: middle;
        }

        /* প্রোফাইল ফটো স্টাইল */
        .user-profile-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            cursor: pointer;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 20px;
            color: white;
        }

        .cart-box {
            position: relative;
            cursor: pointer;
        }

        #cartCount {
            background: #ffda44;
            color: #000;
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 50%;
            font-weight: bold;
            position: absolute;
            top: -12px;
            right: -10px;
        }

        /* স্টক স্ট্যাটাস কালার */
        .stock-info {
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
        }
        .in-stock { color: var(--success-green); }
        .out-stock { color: #d32f2f; }

        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header class="header">
    <a href="index.html" class="brand-logo">
        <img src="https://i.ibb.co/yc5dypjr/1000088857.jpg" alt="CKART">
    </a>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search for products, brands and more...">
        <button onclick="search()"><i class="fa fa-search"></i></button>
    </div>

    <div class="header-actions">
        <div onclick="location.reload()" title="Home"><i class="fa fa-home"></i></div>
        
        <div id="authBox">
            <a href="login.html" style="color: white; text-decoration: none;">
                <i class="fa fa-user"></i>
            </a>
        </div>

        <div class="cart-box">
            <i class="fa fa-shopping-cart"></i>
            <span id="cartCount">0</span>
        </div>
    </div>
</header>

<div class="main-container" id="productGrid">
    <p style="text-align: center; grid-column: 1/-1;">Loading products...</p>
</div>

<div id="modal">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <img id="modalImg" src="" style="max-width: 90%; max-height: 80%; object-fit: contain;">
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
    import { getSupabase } from './config.js';
    const supabase = getSupabase();

    // --- ১. লগইন এবং প্রোফাইল ফটো লজিক ---
    async function checkLogin() {
        const authBox = document.getElementById('authBox');
        const userMobile = localStorage.getItem('customerMobile');

        if (userMobile) {
            // সুপাবেস থেকে ইউজারের প্রোফাইল ফটো নিয়ে আসা
            const { data: user, error } = await supabase
                .from('customers') // আপনার কাস্টমার টেবিলের নাম অনুযায়ী চেক করুন
                .select('profile_img')
                .eq('mobile', userMobile)
                .single();

            let profilePic = '<i class="fa fa-user-circle"></i>';
            if (user && user.profile_img) {
                profilePic = `<img src="${user.profile_img}" class="user-profile-img" alt="Profile">`;
            }

            authBox.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px">
                    <a href="myprofile.html" title="My Profile">${profilePic}</a>
                    <i class="fa fa-sign-out-alt" onclick="logoutUser()" style="color:#ffda44; cursor:pointer" title="Logout"></i>
                </div>
            `;
        }
    }

    window.logoutUser = () => {
        if(confirm("Do you want to logout?")) {
            localStorage.removeItem('customerMobile');
            location.reload();
        }
    }

    // --- ২. ডেটাবেস থেকে সব ডিটেইলসসহ প্রোডাক্ট লোড করা ---
    async function fetchItems() {
        const { data, error } = await supabase
            .from('products')
            .select('*')
            .order('id', { ascending: false });

        if(error) {
            console.error("Error:", error);
            document.getElementById('productGrid').innerHTML = "Error loading products.";
            return;
        }

        const grid = document.getElementById('productGrid');
        grid.innerHTML = "";

        data.forEach(p => {
            const isOutOfStock = p.stock <= 0;
            
            grid.innerHTML += `
                <div class="product-card">
                    <div class="discount-badge">${p.disc}% OFF</div>
                    <div class="image-box" onclick="openZoom('${p.img}')">
                        <img src="${p.img}" alt="${p.name}">
                    </div>
                    <div class="info-box">
                        <div>
                            <div class="p-category">${p.cat}</div>
                            <div class="p-name">${p.name}</div>
                            
                            <div style="font-size: 12px; color: #666;">
                                ${p.content || ''} | Size: ${p.size_text || p.size_num || 'N/A'}
                            </div>

                            <div class="price-box">
                                <span class="final-price">₹${p.price}</span>
                                <span class="mrp">₹${p.mrp}</span>
                                <span class="discount">${p.disc}% off</span>
                            </div>

                            <div class="stock-info ${isOutOfStock ? 'out-stock' : 'in-stock'}">
                                ${isOutOfStock ? 'Out of Stock' : 'In Stock: ' + p.stock}
                            </div>
                        </div>
                        
                        <button class="add-btn" 
                            onclick="addToCart(this)" 
                            ${isOutOfStock ? 'disabled style="background:#ccc"' : ''}>
                            ${isOutOfStock ? 'Unavailable' : 'Add to Cart'}
                        </button>
                    </div>
                </div>
            `;
        });
    }

    // --- ৩. কার্ট কাউন্ট ---
    let cartNum = 0;
    window.addToCart = (btn) => {
        cartNum++;
        document.getElementById('cartCount').innerText = cartNum;
        btn.innerText = "Added ✓";
        btn.style.background = "#388e3c";
    }

    // --- ৪. ইমেজ জুম ---
    window.openZoom = (src) => {
        document.getElementById('modalImg').src = src;
        document.getElementById('modal').style.display = 'flex';
    }

    window.closeModal = () => {
        document.getElementById('modal').style.display = 'none';
    }

    // --- ৫. সার্চ ---
    window.search = () => {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.product-card');
        cards.forEach(card => {
            const name = card.querySelector('.p-name').innerText.toLowerCase();
            card.style.display = name.includes(term) ? "flex" : "none";
        });
    }

    checkLogin();
    fetchItems();
</script>

</body>
</html>
